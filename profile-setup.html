<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Profile Setup - Local Gigs</title>
        <link rel="stylesheet" href="css/style.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    </head>

    <body>
        <div class="auth-container">
            <div class="auth-card profile-setup-card">
                <div class="auth-header">
                    <div class="logo-icon" style="margin: 0 auto 16px auto">
                        LG
                    </div>
                    <h1 class="auth-title">Complete Your Profile</h1>
                    <p class="auth-subtitle">
                        Tell us about yourself to get personalized music
                        recommendations
                    </p>
                </div>

                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">Step 1 of 4</div>
                </div>

                <div id="profileMessages"></div>

                <form id="profileSetupForm">
                    <!-- Step 1: Personal Information -->
                    <div class="setup-step active" data-step="1">
                        <div class="step-header">
                            <div class="step-icon">üë§</div>
                            <h3 class="step-title">Personal Information</h3>
                            <p class="step-description">
                                Let's start with the basics
                            </p>
                        </div>

                        <!-- Profile Picture Upload -->
                        <div class="form-group profile-picture-upload">
                            <label class="form-label">Profile Picture</label>
                            <div class="image-upload-container">
                                <div class="image-preview-wrapper">
                                    <img
                                        id="profilePreview"
                                        class="profile-picture-preview"
                                        style="display: none"
                                        alt="Profile preview"
                                    />
                                    <div
                                        class="upload-placeholder"
                                        id="uploadPlaceholder"
                                    >
                                        <div class="upload-icon">üì∑</div>
                                        <p>Click to add your photo</p>
                                        <small
                                            >JPEG, PNG, or GIF (max 5MB)</small
                                        >
                                    </div>
                                </div>
                                <input
                                    type="file"
                                    id="profilePictureInput"
                                    name="profilePicture"
                                    accept="image/*"
                                    style="display: none"
                                />
                                <div class="upload-actions">
                                    <button
                                        type="button"
                                        class="btn btn-outline upload-btn"
                                        onclick="document.getElementById('profilePictureInput').click()"
                                    >
                                        Choose Photo
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-secondary remove-btn"
                                        id="removePhotoBtn"
                                        style="display: none"
                                        onclick="removeProfilePhoto()"
                                    >
                                        Remove
                                    </button>
                                </div>
                            </div>
                            <div class="form-text">
                                Help others recognize you at events
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="name" class="form-label"
                                >Full Name *</label
                            >
                            <input
                                type="text"
                                id="name"
                                name="name"
                                class="form-control"
                                required
                                placeholder="Enter your full name"
                                maxlength="100"
                            />
                            <div class="form-text">
                                This is how you'll appear to other users
                            </div>
                        </div>

                        <div class="step-actions">
                            <button
                                type="button"
                                class="btn btn-primary"
                                onclick="nextStep()"
                            >
                                Continue ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Music Preferences -->
                    <div class="setup-step" data-step="2">
                        <div class="step-header">
                            <div class="step-icon">üéµ</div>
                            <h3 class="step-title">Music Preferences</h3>
                            <p class="step-description">
                                Choose your favorite genre to get personalized
                                recommendations
                            </p>
                        </div>

                        <div class="form-group">
                            <label class="form-label"
                                >Preferred Music Genre *</label
                            >
                            <div id="genreOptions" class="genre-grid">
                                <!-- Genre options will be populated by JavaScript -->
                            </div>
                            <div class="form-text">
                                You can change this later in your settings
                            </div>
                        </div>

                        <div class="step-actions">
                            <button
                                type="button"
                                class="btn btn-secondary"
                                onclick="prevStep()"
                            >
                                ‚Üê Back
                            </button>
                            <button
                                type="button"
                                class="btn btn-primary"
                                onclick="nextStep()"
                            >
                                Continue ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Notification Settings -->
                    <div class="setup-step" data-step="3">
                        <div class="step-header">
                            <div class="step-icon">üîî</div>
                            <h3 class="step-title">Notification Settings</h3>
                            <p class="step-description">
                                Choose how you'd like to stay updated
                            </p>
                        </div>

                        <div class="settings-group">
                            <div class="toggle-group">
                                <div class="toggle-content">
                                    <div class="toggle-title">
                                        Email Notifications
                                    </div>
                                    <div class="toggle-description">
                                        Get notified about new events in your
                                        preferred genre
                                    </div>
                                </div>
                                <label class="toggle-switch">
                                    <input
                                        type="checkbox"
                                        id="notifications"
                                        name="notifications"
                                        checked
                                    />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="toggle-group">
                                <div class="toggle-content">
                                    <div class="toggle-title">
                                        Weekly Digest
                                    </div>
                                    <div class="toggle-description">
                                        Receive a weekly summary of upcoming
                                        events
                                    </div>
                                </div>
                                <label class="toggle-switch">
                                    <input
                                        type="checkbox"
                                        id="weeklyDigest"
                                        name="weeklyDigest"
                                        checked
                                    />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="toggle-group">
                                <div class="toggle-content">
                                    <div class="toggle-title">
                                        Event Reminders
                                    </div>
                                    <div class="toggle-description">
                                        Get reminded about events you're
                                        interested in
                                    </div>
                                </div>
                                <label class="toggle-switch">
                                    <input
                                        type="checkbox"
                                        id="eventReminders"
                                        name="eventReminders"
                                        checked
                                    />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button
                                type="button"
                                class="btn btn-secondary"
                                onclick="prevStep()"
                            >
                                ‚Üê Back
                            </button>
                            <button
                                type="button"
                                class="btn btn-primary"
                                onclick="nextStep()"
                            >
                                Continue ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: Location Preferences -->
                    <div class="setup-step" data-step="4">
                        <div class="step-header">
                            <div class="step-icon">üìç</div>
                            <h3 class="step-title">Location Preferences</h3>
                            <p class="step-description">
                                Help us show you events near you
                            </p>
                        </div>

                        <div class="settings-group">
                            <div class="toggle-group">
                                <div class="toggle-content">
                                    <div class="toggle-title">
                                        Share Location
                                    </div>
                                    <div class="toggle-description">
                                        Allow us to show events near you
                                    </div>
                                </div>
                                <label class="toggle-switch">
                                    <input
                                        type="checkbox"
                                        id="shareLocation"
                                        name="shareLocation"
                                        checked
                                    />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="location-info">
                                <div class="info-card">
                                    <div class="info-icon">üåç</div>
                                    <div class="info-content">
                                        <h4>Location Benefits</h4>
                                        <ul>
                                            <li>
                                                Discover events happening nearby
                                            </li>
                                            <li>
                                                Get personalized distance-based
                                                recommendations
                                            </li>
                                            <li>
                                                Never miss local music events
                                                again
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button
                                type="button"
                                class="btn btn-secondary"
                                onclick="prevStep()"
                            >
                                ‚Üê Back
                            </button>
                            <button
                                type="button"
                                class="btn btn-primary btn-lg"
                                onclick="submitProfileSetup()"
                            >
                                Complete Setup üéâ
                            </button>
                        </div>
                    </div>
                </form>

                <div class="setup-footer">
                    <p class="footer-text">
                        You can change these preferences later in your profile
                        settings
                    </p>
                </div>
            </div>
        </div>

        <script src="js/config.js"></script>
        <script src="js/utils.js"></script>
        <script src="js/auth.js"></script>

        <style>
            /* Profile Picture Upload Styling */

            .profile-picture-upload {
                margin-bottom: 2rem;
            }

            .image-upload-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }

            .image-preview-wrapper {
                position: relative;
                width: 150px;
                height: 150px;
                border-radius: 50%;
                overflow: hidden;
                border: 3px solid #e9ecef;
                background: #f8f9fa;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .image-preview-wrapper:hover {
                border-color: var(--primary-black);
                background: #f0f0f0;
            }

            .profile-picture-preview {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .upload-placeholder {
                text-align: center;
                color: #6c757d;
                padding: 1rem;
            }

            .upload-icon {
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }

            .upload-placeholder p {
                margin: 0.5rem 0;
                font-weight: 500;
            }

            .upload-placeholder small {
                color: #9ca3af;
                font-size: 0.75rem;
            }

            .upload-actions {
                display: flex;
                gap: 0.75rem;
            }

            .upload-btn,
            .remove-btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            /* Step styling improvements */

            .setup-step {
                display: none;
                animation: fadeIn 0.3s ease-in-out;
            }

            .setup-step.active {
                display: block;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .profile-setup-card {
                max-width: 600px;
                animation: scaleIn 0.5s ease-out;
            }

            .progress-container {
                margin-bottom: 32px;
            }

            .progress-bar {
                width: 100%;
                height: 6px;
                background: var(--border-light);
                border-radius: 3px;
                overflow: hidden;
                margin-bottom: 8px;
            }

            .progress-fill {
                height: 100%;
                background: var(--primary-gradient);
                border-radius: 3px;
                transition: width 0.5s ease;
            }

            .progress-text {
                text-align: center;
                font-size: 12px;
                color: var(--text-secondary);
                font-weight: 500;
            }

            .step-header {
                text-align: center;
                margin-bottom: 32px;
            }

            .step-icon {
                font-size: 48px;
                margin-bottom: 16px;
            }

            .step-title {
                font-size: 24px;
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 8px;
            }

            .step-description {
                font-size: 14px;
                color: var(--text-secondary);
                max-width: 400px;
                margin: 0 auto;
            }

            .genre-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
                margin-top: 16px;
            }

            .genre-option {
                padding: 20px 16px;
                text-align: center;
                border: 2px solid var(--border-color);
                border-radius: var(--radius-lg);
                cursor: pointer;
                transition: var(--transition);
                background: var(--bg-primary);
                position: relative;
                overflow: hidden;
            }

            .genre-option::before {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(102, 126, 234, 0.1),
                    transparent
                );
                transition: left 0.5s ease;
            }

            .genre-option:hover::before {
                left: 100%;
            }

            .genre-option:hover {
                border-color: var(--primary-color);
                transform: translateY(-4px);
                box-shadow: var(--shadow-lg);
            }

            .genre-option.selected {
                border-color: var(--primary-color);
                background: var(--primary-color);
                color: white;
                transform: translateY(-4px);
                box-shadow: var(--shadow-lg);
            }

            .genre-content {
                position: relative;
                z-index: 1;
            }

            .genre-emoji {
                font-size: 24px;
                margin-bottom: 8px;
            }

            .genre-name {
                font-size: 14px;
                font-weight: 500;
            }

            .settings-group {
                margin-bottom: 24px;
            }

            .toggle-group {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 20px;
                background: var(--bg-primary);
                border: 1px solid var(--border-light);
                border-radius: var(--radius-lg);
                margin-bottom: 16px;
                transition: var(--transition);
            }

            .toggle-group:hover {
                border-color: var(--primary-color);
                box-shadow: var(--shadow-sm);
            }

            .toggle-content {
                flex: 1;
            }

            .toggle-title {
                font-size: 16px;
                font-weight: 500;
                color: var(--text-primary);
                margin-bottom: 4px;
            }

            .toggle-description {
                font-size: 13px;
                color: var(--text-secondary);
            }

            .location-info {
                margin-top: 24px;
            }

            .info-card {
                background: var(--bg-secondary);
                border: 1px solid var(--border-light);
                border-radius: var(--radius-lg);
                padding: 20px;
                display: flex;
                gap: 16px;
                transition: var(--transition);
            }

            .info-icon {
                font-size: 32px;
                flex-shrink: 0;
            }

            .info-content h4 {
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 8px;
            }

            .info-content ul {
                list-style: none;
                padding: 0;
            }

            .info-content li {
                font-size: 13px;
                color: var(--text-secondary);
                margin-bottom: 4px;
                position: relative;
                padding-left: 16px;
            }

            .info-content li::before {
                content: "‚úì";
                position: absolute;
                left: 0;
                color: var(--primary-color);
                font-weight: 600;
            }

            .step-actions {
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-top: 32px;
                flex-wrap: wrap;
            }

            .setup-footer {
                margin-top: 32px;
                padding-top: 24px;
                border-top: 1px solid var(--border-light);
                text-align: center;
            }

            .footer-text {
                font-size: 13px;
                color: var(--text-secondary);
                margin: 0;
            }

            .auth-container {
                background: var(--primary-gradient);
                position: relative;
            }

            .auth-container::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><polygon fill="%23ffffff08" points="0,1000 1000,0 1000,1000"/></svg>');
                pointer-events: none;
            }

            @media (max-width: 768px) {
                .profile-setup-card {
                    margin: 16px;
                    padding: 24px;
                }
                .step-title {
                    font-size: 20px;
                }
                .genre-grid {
                    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                }
                .step-actions {
                    flex-direction: column;
                }
                .step-actions .btn {
                    width: 100%;
                }
                .toggle-group {
                    padding: 16px;
                }
                .info-card {
                    flex-direction: column;
                    text-align: center;
                }
            }

            @media (max-width: 480px) {
                .genre-option {
                    padding: 16px 12px;
                }
                .genre-emoji {
                    font-size: 20px;
                }
                .genre-name {
                    font-size: 12px;
                }
                .step-icon {
                    font-size: 40px;
                }
            }
        </style>

        <script>
            let selectedProfilePicture = null;
            let currentStep = 1;
            const totalSteps = 4;

            // Initialize navigation fix
            Utils.initializeNavigation();

            // Profile Manager - Using EXACT same logic as profile.html
            const ProfileSetupManager = {
                currentUser: null,

                init: async function () {
                    // Check authentication
                    if (!Utils.requireAuth()) {
                        return;
                    }

                    this.currentUser = Utils.getUserFromToken();
                    console.log(
                        "Profile Setup - Current user:",
                        this.currentUser,
                    );

                    // Initialize profile picture handling
                    this.initializeProfilePictureHandling();

                    // Setup genre options
                    this.setupGenreOptions();

                    // Setup location handling
                    this.setupLocationHandling();

                    // Update progress
                    this.updateProgress();

                    // Load existing profile data if available
                    await this.loadExistingProfile();
                },

                initializeProfilePictureHandling: function () {
                    const profileInput = document.getElementById(
                        "profilePictureInput",
                    );
                    const profilePreview =
                        document.getElementById("profilePreview");
                    const placeholder =
                        document.getElementById("uploadPlaceholder");
                    const removeBtn = document.getElementById("removePhotoBtn");

                    if (profileInput) {
                        profileInput.addEventListener("change", (e) => {
                            const file = e.target.files[0];
                            if (!file) return;

                            try {
                                // Check file size (5MB limit)
                                if (file.size > 5 * 1024 * 1024) {
                                    throw new Error(
                                        "Image file must be less than 5MB",
                                    );
                                }

                                selectedProfilePicture = file;

                                // Show preview
                                const reader = new FileReader();
                                reader.onload = function (e) {
                                    profilePreview.src = e.target.result;
                                    profilePreview.style.display = "block";
                                    placeholder.style.display = "none";
                                    removeBtn.style.display = "inline-block";
                                };
                                reader.readAsDataURL(file);
                            } catch (error) {
                                alert(error.message);
                                profileInput.value = "";
                            }
                        });
                    }

                    // Click handler for preview wrapper
                    const previewWrapper = document.querySelector(
                        ".image-preview-wrapper",
                    );
                    if (previewWrapper) {
                        previewWrapper.addEventListener("click", () => {
                            profileInput.click();
                        });
                    }
                },

                setupGenreOptions: function () {
                    const genreContainer =
                        document.getElementById("genreOptions");
                    if (!genreContainer) return;

                    genreContainer.innerHTML = "";

                    CONFIG.PREFERENCES.GENRES.forEach((genre) => {
                        const genreOption = document.createElement("div");
                        genreOption.className = "genre-option";
                        genreOption.dataset.genre = genre;
                        genreOption.innerHTML = `
                            <input type="radio" name="genre" value="${genre}" id="genre-${genre}" hidden>
                            <div class="genre-content">
                                <div class="genre-emoji">${this.getGenreEmoji(genre)}</div>
                                <div class="genre-name">${Utils.capitalize(genre)}</div>
                            </div>
                        `;

                        genreOption.addEventListener("click", () => {
                            // Remove selected class from all options
                            document
                                .querySelectorAll(".genre-option")
                                .forEach((opt) => {
                                    opt.classList.remove("selected");
                                });

                            // Add selected class to clicked option
                            genreOption.classList.add("selected");

                            // Select the radio button
                            genreOption.querySelector(
                                'input[type="radio"]',
                            ).checked = true;
                        });

                        genreContainer.appendChild(genreOption);
                    });
                },

                getGenreEmoji: function (genre) {
                    const emojis = {
                        rock: "üé∏",
                        pop: "üé§",
                        jazz: "üé∫",
                        electronic: "üéß",
                        "hip-hop": "üéµ",
                        hiphop: "üéµ",
                        indie: "üé∂",
                        metal: "‚ö°",
                        country: "ü§†",
                        reggae: "üå¥",
                        classical: "üéº",
                        soul: "üí´",
                        rnb: "‚ú®",
                    };
                    return emojis[genre] || "üéµ";
                },

                setupLocationHandling: function () {
                    const shareLocationToggle =
                        document.getElementById("shareLocation");
                    shareLocationToggle.addEventListener("change", function () {
                        if (this.checked) {
                            Utils.getCurrentLocation()
                                .then((location) => {
                                    console.log("User location:", location);
                                    sessionStorage.setItem(
                                        "userLocation",
                                        JSON.stringify(location),
                                    );
                                    ProfileSetupManager.showLocationSuccess();
                                })
                                .catch((error) => {
                                    console.error(
                                        "Location access denied:",
                                        error,
                                    );
                                    ProfileSetupManager.showLocationError();
                                    this.checked = false;
                                });
                        } else {
                            sessionStorage.removeItem("userLocation");
                        }
                    });
                },

                showLocationSuccess: function () {
                    const infoCard = document.querySelector(".info-card");
                    infoCard.style.borderColor = "var(--primary-color)";
                    infoCard.style.background = "rgba(102, 126, 234, 0.05)";

                    setTimeout(() => {
                        infoCard.style.borderColor = "var(--border-light)";
                        infoCard.style.background = "var(--bg-secondary)";
                    }, 2000);
                },

                showLocationError: function () {
                    Utils.showError(
                        "Location access denied. You can enable this later in settings.",
                        "profileMessages",
                    );
                },

                updateProgress: function () {
                    const progressFill =
                        document.querySelector(".progress-fill");
                    const progressText =
                        document.querySelector(".progress-text");

                    const percentage = (currentStep / totalSteps) * 100;
                    progressFill.style.width = `${percentage}%`;
                    progressText.textContent = `Step ${currentStep} of ${totalSteps}`;
                },

                loadExistingProfile: async function () {
                    try {
                        if (!this.currentUser) return;

                        // Try to get existing profile data using EXACT same logic as profile.html
                        const url = CONFIG.buildApiUrl(
                            CONFIG.API.ENDPOINTS.USERS,
                            this.currentUser.sub,
                        );
                        const existingProfile = await Utils.apiCall(url, {
                            method: "GET",
                            headers: CONFIG.getAuthHeaders(),
                        });

                        if (existingProfile) {
                            console.log(
                                "Loading existing profile data:",
                                existingProfile,
                            );

                            // Pre-fill name
                            if (existingProfile.name) {
                                document.getElementById("name").value =
                                    existingProfile.name;
                            }

                            // Pre-fill preferences if they exist
                            if (existingProfile.preferences) {
                                // Set notifications
                                if (
                                    typeof existingProfile.preferences
                                        .notifications === "boolean"
                                ) {
                                    document.getElementById(
                                        "notifications",
                                    ).checked =
                                        existingProfile.preferences.notifications;
                                }

                                // Set weekly digest
                                if (
                                    typeof existingProfile.preferences
                                        .weeklyDigest === "boolean"
                                ) {
                                    document.getElementById(
                                        "weeklyDigest",
                                    ).checked =
                                        existingProfile.preferences.weeklyDigest;
                                }

                                // Set event reminders
                                if (
                                    typeof existingProfile.preferences
                                        .eventReminders === "boolean"
                                ) {
                                    document.getElementById(
                                        "eventReminders",
                                    ).checked =
                                        existingProfile.preferences.eventReminders;
                                }

                                // Set location sharing
                                if (
                                    typeof existingProfile.preferences
                                        .shareLocation === "boolean"
                                ) {
                                    document.getElementById(
                                        "shareLocation",
                                    ).checked =
                                        existingProfile.preferences.shareLocation;
                                }

                                // Pre-select genre
                                if (existingProfile.preferences.genre) {
                                    setTimeout(() => {
                                        const genreOption =
                                            document.querySelector(
                                                `.genre-option[data-genre="${existingProfile.preferences.genre}"]`,
                                            );
                                        if (genreOption) {
                                            genreOption.click();
                                        }
                                    }, 100);
                                }
                            }

                            // Show existing profile picture if available
                            if (existingProfile.profilePictureUrl) {
                                const profilePreview =
                                    document.getElementById("profilePreview");
                                const placeholder =
                                    document.getElementById(
                                        "uploadPlaceholder",
                                    );
                                const removeBtn =
                                    document.getElementById("removePhotoBtn");

                                profilePreview.src =
                                    existingProfile.profilePictureUrl;
                                profilePreview.style.display = "block";
                                placeholder.style.display = "none";
                                removeBtn.style.display = "inline-block";
                            }
                        }
                    } catch (error) {
                        console.log(
                            "No existing profile found or error loading:",
                            error,
                        );
                        // Continue with empty form if no profile exists
                    }

                    // Get user info to pre-fill name if not already set
                    if (
                        this.currentUser &&
                        this.currentUser.preferredUsername &&
                        !document.getElementById("name").value
                    ) {
                        document.getElementById("name").value =
                            this.currentUser.preferredUsername;
                    }
                },

                // Save profile using EXACT same logic as profile.html
                saveProfile: async function () {
                    const submitBtn = document.querySelector(
                        '.btn[onclick="submitProfileSetup()"]',
                    );

                    try {
                        Utils.showLoading(submitBtn, "Setting up profile...");

                        if (!this.currentUser) {
                            throw new Error("User not authenticated");
                        }

                        // Get form data
                        const name = document.getElementById("name").value;
                        const selectedGenre = document.querySelector(
                            ".genre-option.selected",
                        )?.dataset.genre;
                        const notifications =
                            document.getElementById("notifications").checked;
                        const weeklyDigest =
                            document.getElementById("weeklyDigest").checked;
                        const eventReminders =
                            document.getElementById("eventReminders").checked;
                        const shareLocation =
                            document.getElementById("shareLocation").checked;

                        let profilePictureUrl = null;

                        // Upload profile picture if selected
                        if (selectedProfilePicture) {
                            try {
                                profilePictureUrl = await Utils.uploadImage(
                                    selectedProfilePicture,
                                    "users",
                                );
                                console.log(
                                    "Profile picture uploaded:",
                                    profilePictureUrl,
                                );
                            } catch (uploadError) {
                                console.error(
                                    "Profile picture upload failed:",
                                    uploadError,
                                );
                                // Continue without profile picture
                            }
                        }

                        // Prepare profile data - EXACT same structure as profile.html
                        const profileData = {
                            userID: this.currentUser.sub,
                            name: name || "",
                            email: this.currentUser.email || "",
                            profileSetupComplete: true,
                            preferences: {
                                genre: selectedGenre || "rock",
                                notifications: notifications,
                                weeklyDigest: weeklyDigest,
                                eventReminders: eventReminders,
                                shareLocation: shareLocation,
                            },
                        };

                        // Add profile picture URL if uploaded
                        if (profilePictureUrl) {
                            profileData.profilePictureUrl = profilePictureUrl;
                        }

                        console.log("Profile data being sent:", profileData);

                        // Use EXACT same API call as profile.html - PUT with userID in URL
                        const url = CONFIG.buildApiUrl(
                            CONFIG.API.ENDPOINTS.USERS,
                            this.currentUser.sub,
                        );
                        const response = await Utils.apiCall(url, {
                            method: "PUT",
                            headers: CONFIG.getAuthHeaders(),
                            body: JSON.stringify(profileData),
                        });

                        console.log("Profile save response:", response);

                        Utils.showSuccess(
                            "Profile setup complete! Redirecting to dashboard...",
                        );

                        // Redirect to dashboard
                        setTimeout(() => {
                            window.location.href = "dashboard.html";
                        }, 2000);
                    } catch (error) {
                        console.error("Profile setup failed:", error);
                        Utils.showError(
                            error.message ||
                                "Failed to setup profile. Please try again.",
                        );
                    } finally {
                        Utils.hideLoading(submitBtn, "Complete Setup");
                    }
                },
            };

            // Global functions for step navigation
            function removeProfilePhoto() {
                const profilePreview =
                    document.getElementById("profilePreview");
                const placeholder =
                    document.getElementById("uploadPlaceholder");
                const removeBtn = document.getElementById("removePhotoBtn");
                const profileInput = document.getElementById(
                    "profilePictureInput",
                );

                selectedProfilePicture = null;
                profileInput.value = "";
                profilePreview.style.display = "none";
                placeholder.style.display = "block";
                removeBtn.style.display = "none";
            }

            function nextStep() {
                if (validateCurrentStep()) {
                    if (currentStep < totalSteps) {
                        // Hide current step
                        document
                            .querySelector(`[data-step="${currentStep}"]`)
                            .classList.remove("active");

                        // Show next step
                        currentStep++;
                        document
                            .querySelector(`[data-step="${currentStep}"]`)
                            .classList.add("active");

                        // Update progress
                        ProfileSetupManager.updateProgress();

                        // Scroll to top
                        document.querySelector(".auth-card").scrollIntoView({
                            behavior: "smooth",
                        });
                    }
                }
            }

            function prevStep() {
                if (currentStep > 1) {
                    // Hide current step
                    document
                        .querySelector(`[data-step="${currentStep}"]`)
                        .classList.remove("active");

                    // Show previous step
                    currentStep--;
                    document
                        .querySelector(`[data-step="${currentStep}"]`)
                        .classList.add("active");

                    // Update progress
                    ProfileSetupManager.updateProgress();

                    // Scroll to top
                    document.querySelector(".auth-card").scrollIntoView({
                        behavior: "smooth",
                    });
                }
            }

            function validateCurrentStep() {
                switch (currentStep) {
                    case 1:
                        const name = document
                            .getElementById("name")
                            .value.trim();
                        if (!name) {
                            Utils.showError(
                                "Please enter your name",
                                "profileMessages",
                            );
                            return false;
                        }
                        break;
                    case 2:
                        const selectedGenre = document.querySelector(
                            'input[name="genre"]:checked',
                        );
                        if (!selectedGenre) {
                            Utils.showError(
                                "Please select your preferred genre",
                                "profileMessages",
                            );
                            return false;
                        }
                        break;
                }

                // Clear any previous error messages
                const messagesContainer =
                    document.getElementById("profileMessages");
                if (messagesContainer) {
                    messagesContainer.innerHTML = "";
                }

                return true;
            }

            // Submit function that calls the ProfileSetupManager
            async function submitProfileSetup() {
                await ProfileSetupManager.saveProfile();
            }

            // Initialize when DOM is loaded
            document.addEventListener("DOMContentLoaded", function () {
                ProfileSetupManager.init();
            });
        </script>

        <style>
            .setup-step {
                display: none;
                animation: fadeIn 0.3s ease-out;
            }

            .setup-step.active {
                display: block;
            }
        </style>
    </body>
</html>
