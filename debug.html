<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Gigs - Debug Console</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .debug-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }
        
        .debug-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .debug-section h2 {
            color: #333;
            margin-bottom: 1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }
        
        .test-result {
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .btn-test {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.25rem;
        }
        
        .btn-test:hover {
            background: #5a6fd8;
        }
        
        .btn-test:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">Local Gigs</a>
            <nav>
                <ul class="nav-menu">
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="events.html">Events</a></li>
                    <li><a href="venues.html">Venues</a></li>
                    <li><a href="profile.html">Profile</a></li>
                    <li><button class="btn logout-btn" id="logout-button">Logout</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="debug-container">
        <h1>üîß Local Gigs Debug Console</h1>

        <div class="debug-section">
            <h2>Authentication Status</h2>
            <div id="auth-status"></div>
            <button class="btn-test" onclick="testAuth()">Test Authentication</button>
        </div>

        <div class="debug-section">
            <h2>Profile System Test</h2>
            <div id="profile-status"></div>
            <button class="btn-test" onclick="testProfileSystem()">Test Profile Loading</button>
            <button class="btn-test" onclick="testTokenDecoding()">Test Token Decoding</button>
            <button class="btn-test" onclick="testUserFromToken()">Test Get User From Token</button>
            <button class="btn-test" onclick="testProfileRender()">Test Profile Rendering</button>
        </div>

        <div class="debug-section">
            <h2>API Endpoints Test</h2>
            <div id="api-status"></div>
            <button class="btn-test" onclick="testUserAPI()">Test User API</button>
            <button class="btn-test" onclick="testEventsAPI()">Test Events API</button>
            <button class="btn-test" onclick="testVenuesAPI()">Test Venues API</button>
            <button class="btn-test" onclick="testUploadAPI()">Test Upload API</button>
            <button class="btn-test" onclick="testSignupAPI()">Test Signup API</button>
            <button class="btn-test" onclick="testListUsers()">List All Users</button>
            <button class="btn-test" onclick="testUserLookupByEmail()">Test User Lookup by Email</button>
            <button class="btn-test" onclick="testUserUpdate()">Test User Update</button>
            <button class="btn-test" onclick="testUserUpdateDetailed()">Test User Update (Detailed)</button>
            <button class="btn-test" onclick="debugUserState()">Debug User State</button>
        </div>

        <div class="debug-section">
            <h2>AWS Location Service Test</h2>
            <div id="location-status"></div>
            <button class="btn-test" onclick="testLocationService()">Test Location Service</button>
        </div>

        <div class="debug-section">
            <h2>Configuration Check</h2>
            <div id="config-status"></div>
            <button class="btn-test" onclick="checkConfig()">Check Configuration</button>
        </div>

        <div class="debug-section">
            <h2>Console Logs</h2>
            <div id="console-logs">
                <div class="test-result info">Console logs will appear here...</div>
            </div>
            <button class="btn-test" onclick="clearLogs()">Clear Logs</button>
        </div>
    </main>

    <script src="js/config.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1691.0.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(message, type = 'info') {
            const logsContainer = document.getElementById('console-logs');
            const logElement = document.createElement('div');
            logElement.className = `test-result ${type}`;
            logElement.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsContainer.appendChild(logElement);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.textContent = message;
            container.appendChild(result);
        }

        function clearContainer(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function clearLogs() {
            document.getElementById('console-logs').innerHTML = '<div class="test-result info">Console logs cleared...</div>';
        }

        async function testAuth() {
            clearContainer('auth-status');

            try {
                const accessToken = localStorage.getItem(CONFIG.STORAGE_KEYS.ACCESS_TOKEN);
                const idToken = localStorage.getItem(CONFIG.STORAGE_KEYS.ID_TOKEN);

                if (!accessToken && !idToken) {
                    addResult('auth-status', '‚ùå No authentication tokens found', 'error');
                    return;
                }

                addResult('auth-status', '‚úÖ Authentication tokens found', 'success');

                // Try to decode token
                if (idToken) {
                    try {
                        const payload = JSON.parse(atob(idToken.split('.')[1]));
                        addResult('auth-status', `‚úÖ User ID: ${payload.sub}`, 'success');
                        addResult('auth-status', `‚úÖ Email: ${payload.email}`, 'success');
                        addResult('auth-status', `‚úÖ Token expires: ${new Date(payload.exp * 1000).toLocaleString()}`, 'info');
                    } catch (e) {
                        addResult('auth-status', '‚ö†Ô∏è Could not decode ID token', 'error');
                    }
                }

            } catch (error) {
                addResult('auth-status', `‚ùå Auth test failed: ${error.message}`, 'error');
            }
        }

        async function testUserAPI() {
            clearContainer('api-status');

            try {
                const currentUser = Utils.getCurrentUser();
                if (!currentUser) {
                    addResult('api-status', '‚ùå No current user found', 'error');
                    return;
                }

                const url = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS, currentUser.sub);
                addResult('api-status', `Testing: ${url}`, 'info');

                const response = await Utils.apiCall(url, {
                    method: "GET",
                    headers: CONFIG.getAuthHeaders(),
                });

                addResult('api-status', '‚úÖ User API working', 'success');
                addResult('api-status', `Response: ${JSON.stringify(response, null, 2)}`, 'info');

            } catch (error) {
                addResult('api-status', `‚ùå User API failed: ${error.message}`, 'error');
            }
        }

        async function testEventsAPI() {
            try {
                const url = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.EVENTS);
                addResult('api-status', `Testing: ${url}`, 'info');

                const response = await Utils.apiCall(url, {
                    method: "GET",
                    headers: CONFIG.getAuthHeaders(),
                });

                addResult('api-status', '‚úÖ Events API working', 'success');

                // Check response format
                if (Array.isArray(response)) {
                    addResult('api-status', `‚úÖ Events returned as array: ${response.length} events`, 'success');
                } else if (response.message) {
                    addResult('api-status', `‚ö†Ô∏è Events returned in message field`, 'error');
                    try {
                        const parsed = JSON.parse(response.message);
                        addResult('api-status', `‚úÖ Parsed ${parsed.length} events from message`, 'success');
                    } catch (e) {
                        addResult('api-status', `‚ùå Could not parse events message`, 'error');
                    }
                } else {
                    addResult('api-status', `‚ö†Ô∏è Unexpected response format`, 'error');
                }

            } catch (error) {
                addResult('api-status', `‚ùå Events API failed: ${error.message}`, 'error');
            }
        }

        async function testVenuesAPI() {
            try {
                const url = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.VENUES);
                addResult('api-status', `Testing: ${url}`, 'info');

                const response = await Utils.apiCall(url, {
                    method: "GET",
                    headers: CONFIG.getAuthHeaders(),
                });

                addResult('api-status', '‚úÖ Venues API working', 'success');

                // Check response format
                if (Array.isArray(response)) {
                    addResult('api-status', `‚úÖ Venues returned as array: ${response.length} venues`, 'success');
                } else if (response.message) {
                    addResult('api-status', `‚ö†Ô∏è Venues returned in message field`, 'error');
                    try {
                        const parsed = JSON.parse(response.message);
                        addResult('api-status', `‚úÖ Parsed ${parsed.length} venues from message`, 'success');
                    } catch (e) {
                        addResult('api-status', `‚ùå Could not parse venues message`, 'error');
                    }
                } else {
                    addResult('api-status', `‚ö†Ô∏è Unexpected response format`, 'error');
                }

            } catch (error) {
                addResult('api-status', `‚ùå Venues API failed: ${error.message}`, 'error');
            }
        }

        async function testUploadAPI() {
            try {
                // Create a small test image
                const canvas = document.createElement('canvas');
                canvas.width = 10;
                canvas.height = 10;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(0, 0, 10, 10);

                canvas.toBlob(async(blob) => {
                    try {
                        const file = new File([blob], 'test.png', {
                            type: 'image/png'
                        });
                        addResult('api-status', `Testing upload with ${file.size} byte test image`, 'info');

                        const imageUrl = await Utils.uploadImage(file, 'test');
                        addResult('api-status', '‚úÖ Upload API working', 'success');
                        addResult('api-status', `Image URL: ${imageUrl}`, 'info');

                    } catch (error) {
                        addResult('api-status', `‚ùå Upload API failed: ${error.message}`, 'error');
                    }
                }, 'image/png');

            } catch (error) {
                addResult('api-status', `‚ùå Upload test setup failed: ${error.message}`, 'error');
            }
        }

        async function testSignupAPI() {
            try {
                addResult('api-status', 'Testing Signup API with sample data...', 'info');

                const testUsername = 'testuser' + Date.now();
                const testEmail = `test${Date.now()}@example.com`;

                const signupData = {
                    username: testUsername,
                    email: testEmail,
                    password: 'TestPassword123!',
                    preferred_username: testUsername // Required by Cognito
                };

                const url = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.SIGNUP);
                addResult('api-status', `Testing: ${url}`, 'info');
                addResult('api-status', `Test data: ${JSON.stringify(signupData, null, 2)}`, 'info');

                const response = await Utils.apiCall(url, {
                    method: "POST",
                    headers: CONFIG.getBasicHeaders(),
                    body: JSON.stringify(signupData),
                });

                addResult('api-status', '‚úÖ Signup API working', 'success');
                addResult('api-status', `Response: ${JSON.stringify(response, null, 2)}`, 'info');
                addResult('api-status', '‚ö†Ô∏è Note: This created a test user that may need cleanup', 'error');

            } catch (error) {
                addResult('api-status', `‚ùå Signup API failed: ${error.message}`, 'error');
            }
        }

        async function testListUsers() {
            try {
                addResult('api-status', 'Testing list all users...', 'info');

                const url = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS);
                addResult('api-status', `Testing: ${url}`, 'info');

                const response = await Utils.apiCall(url, {
                    method: "GET",
                    headers: CONFIG.getAuthHeaders(),
                });

                addResult('api-status', '‚úÖ List users API working', 'success');
                addResult('api-status', `Users found: ${JSON.stringify(response, null, 2)}`, 'info');

            } catch (error) {
                addResult('api-status', `‚ùå List users API failed: ${error.message}`, 'error');
            }
        }

        async function testUserLookupByEmail() {
            try {
                addResult('api-status', 'Testing user lookup by email...', 'info');

                const currentUser = Utils.getCurrentUser();
                if (!currentUser) {
                    addResult('api-status', '‚ùå No current user found', 'error');
                    return;
                }

                addResult('api-status', `Current user email: ${currentUser.email}`, 'info');
                addResult('api-status', `Current user sub: ${currentUser.sub}`, 'info');

                // Try to find user by email in the users list
                const usersUrl = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS);
                const usersResponse = await Utils.apiCall(usersUrl, {
                    method: "GET",
                    headers: CONFIG.getAuthHeaders(),
                });

                addResult('api-status', `All users response: ${JSON.stringify(usersResponse, null, 2)}`, 'info');

                // Check if we can find current user by email
                let users = [];
                if (Array.isArray(usersResponse)) {
                    users = usersResponse;
                } else if (usersResponse.Items) {
                    users = usersResponse.Items;
                } else if (usersResponse.message) {
                    try {
                        users = JSON.parse(usersResponse.message);
                    } catch (e) {
                        addResult('api-status', '‚ùå Could not parse users response', 'error');
                        return;
                    }
                }

                const matchingUser = users.find(user => user.email === currentUser.email);
                if (matchingUser) {
                    addResult('api-status', `‚úÖ Found matching user: ${JSON.stringify(matchingUser, null, 2)}`, 'success');
                } else {
                    addResult('api-status', `‚ùå No user found with email: ${currentUser.email}`, 'error');
                }

            } catch (error) {
                addResult('api-status', `‚ùå User lookup by email failed: ${error.message}`, 'error');
            }
        }

        async function testListUsers() {
            try {
                addResult('api-status', 'Testing list all users...', 'info');

                const url = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS);
                addResult('api-status', `Testing: ${url}`, 'info');

                const response = await Utils.apiCall(url, {
                    method: "GET",
                    headers: CONFIG.getAuthHeaders(),
                });

                addResult('api-status', '‚úÖ List users API working', 'success');
                addResult('api-status', `Users found: ${JSON.stringify(response, null, 2)}`, 'info');

            } catch (error) {
                addResult('api-status', `‚ùå List users API failed: ${error.message}`, 'error');
            }
        }

        async function testUserLookupByEmail() {
            try {
                addResult('api-status', 'Testing user lookup by email...', 'info');

                const currentUser = Utils.getCurrentUser();
                if (!currentUser) {
                    addResult('api-status', '‚ùå No current user found', 'error');
                    return;
                }

                addResult('api-status', `Current user email: ${currentUser.email}`, 'info');
                addResult('api-status', `Current user sub: ${currentUser.sub}`, 'info');

                // Try to lookup user by their email instead of sub
                const emailUrl = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS, currentUser.email);
                addResult('api-status', `Testing lookup by email: ${emailUrl}`, 'info');

                const emailResponse = await Utils.apiCall(emailUrl, {
                    method: "GET",
                    headers: CONFIG.getAuthHeaders(),
                });

                addResult('api-status', '‚úÖ User lookup by email working', 'success');
                addResult('api-status', `User found: ${JSON.stringify(emailResponse, null, 2)}`, 'info');

            } catch (error) {
                addResult('api-status', `‚ùå User lookup by email failed: ${error.message}`, 'error');

                // Also try listing all users to see what's available
                try {
                    addResult('api-status', 'Trying to list all users for comparison...', 'info');
                    const usersUrl = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS);
                    const usersResponse = await Utils.apiCall(usersUrl, {
                        method: "GET",
                        headers: CONFIG.getAuthHeaders(),
                    });
                    addResult('api-status', `All users: ${JSON.stringify(usersResponse, null, 2)}`, 'info');
                } catch (listError) {
                    addResult('api-status', `Could not list users: ${listError.message}`, 'error');
                }
            }
        }

        async function testLocationService() {
            clearContainer('location-status');

            try {
                addResult('location-status', 'Testing AWS Location Service setup...', 'info');

                // Check if AWS SDK is loaded
                if (typeof AWS === 'undefined') {
                    addResult('location-status', '‚ùå AWS SDK not loaded', 'error');
                    return;
                }

                addResult('location-status', '‚úÖ AWS SDK loaded', 'success');

                // Check credentials
                const accessToken = localStorage.getItem(CONFIG.STORAGE_KEYS.ACCESS_TOKEN);
                const idToken = localStorage.getItem(CONFIG.STORAGE_KEYS.ID_TOKEN);

                if (!accessToken && !idToken) {
                    addResult('location-status', '‚ùå No authentication tokens for Location Service', 'error');
                    return;
                }

                addResult('location-status', '‚úÖ Authentication tokens available', 'success');

                // Test AWS credentials setup
                AWS.config.region = CONFIG.COGNITO.REGION;
                AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                    IdentityPoolId: CONFIG.COGNITO.IDENTITY_POOL_ID,
                    Logins: {
                        [`cognito-idp.${CONFIG.COGNITO.REGION}.amazonaws.com/${CONFIG.COGNITO.USER_POOL_ID}`]: idToken || accessToken
                    }
                });

                addResult('location-status', '‚úÖ AWS credentials configured', 'success');

                // Try to refresh credentials
                AWS.config.credentials.refresh((error) => {
                    if (error) {
                        addResult('location-status', `‚ùå Failed to refresh credentials: ${error.message}`, 'error');
                    } else {
                        addResult('location-status', '‚úÖ AWS credentials refreshed successfully', 'success');
                    }
                });

            } catch (error) {
                addResult('location-status', `‚ùå Location Service test failed: ${error.message}`, 'error');
            }
        }

        function checkConfig() {
            clearContainer('config-status');

            try {
                addResult('config-status', 'Checking configuration...', 'info');

                // Check API configuration
                addResult('config-status', `API Base URL: ${CONFIG.API.BASE_URL}`, 'info');
                addResult('config-status', `Cognito Region: ${CONFIG.COGNITO.REGION}`, 'info');
                addResult('config-status', `User Pool ID: ${CONFIG.COGNITO.USER_POOL_ID}`, 'info');
                addResult('config-status', `Client ID: ${CONFIG.COGNITO.CLIENT_ID}`, 'info');
                addResult('config-status', `Identity Pool ID: ${CONFIG.COGNITO.IDENTITY_POOL_ID}`, 'info');

                // Check Location Service config
                addResult('config-status', `Location Map Name: ${CONFIG.LOCATION.MAP_NAME}`, 'info');
                addResult('config-status', `Location Place Index: ${CONFIG.LOCATION.PLACE_INDEX_NAME}`, 'info');

                // Validate configuration
                if (CONFIG.validateAWSConfig()) {
                    addResult('config-status', '‚úÖ Configuration validation passed', 'success');
                } else {
                    addResult('config-status', '‚ùå Configuration validation failed', 'error');
                }

            } catch (error) {
                addResult('config-status', `‚ùå Config check failed: ${error.message}`, 'error');
            }
        }

        async function testListUsers() {
            try {
                addResult('api-status', 'Testing List All Users...', 'info');

                const url = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS);
                addResult('api-status', `Testing: ${url}`, 'info');

                const response = await Utils.apiCall(url, {
                    method: "GET",
                    headers: CONFIG.getAuthHeaders(),
                });

                addResult('api-status', '‚úÖ List Users API working', 'success');

                if (Array.isArray(response)) {
                    addResult('api-status', `Found ${response.length} users in DynamoDB`, 'success');
                    response.forEach((user, index) => {
                        addResult('api-status', `User ${index + 1}: ${user.userID} (${user.email})`, 'info');
                    });
                } else {
                    addResult('api-status', `Response: ${JSON.stringify(response, null, 2)}`, 'info');
                }

            } catch (error) {
                addResult('api-status', `‚ùå List Users API failed: ${error.message}`, 'error');
            }
        }

        async function testUserLookupByEmail() {
            try {
                const currentUser = Utils.getCurrentUser();
                if (!currentUser || !currentUser.email) {
                    addResult('api-status', '‚ùå No current user email found for lookup test', 'error');
                    return;
                }

                addResult('api-status', `Testing User Lookup by Email: ${currentUser.email}`, 'info');

                const url = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS, currentUser.email);
                addResult('api-status', `Testing: ${url}`, 'info');

                const response = await Utils.apiCall(url, {
                    method: "GET",
                    headers: CONFIG.getAuthHeaders(),
                });

                addResult('api-status', '‚úÖ User lookup by email working', 'success');
                addResult('api-status', `Found user: ${JSON.stringify(response, null, 2)}`, 'info');

            } catch (error) {
                addResult('api-status', `‚ùå User lookup by email failed: ${error.message}`, 'error');
            }
        }

        async function testUserUpdate() {
            try {
                const currentUser = Utils.getCurrentUser();
                if (!currentUser) {
                    addResult('api-status', '‚ùå No current user found for update test', 'error');
                    return;
                }

                addResult('api-status', 'Testing User Update...', 'info');

                const testUpdateData = {
                    userID: currentUser.sub,
                    name: 'Test User Updated',
                    email: currentUser.email,
                    preferences: {
                        genres: ['rock', 'jazz'],
                        emailNotifications: true,
                        eventReminders: true,
                        locationSuggestions: false
                    }
                };

                // Test PUT with userID in path (preferred method)
                try {
                    const urlWithPath = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS, currentUser.sub);
                    addResult('api-status', `Testing PUT with path: ${urlWithPath}`, 'info');

                    const response1 = await Utils.apiCall(urlWithPath, {
                        method: "PUT",
                        headers: CONFIG.getAuthHeaders(),
                        body: JSON.stringify(testUpdateData),
                    });

                    addResult('api-status', '‚úÖ User update with path parameter working', 'success');
                    addResult('api-status', `Response: ${JSON.stringify(response1, null, 2)}`, 'info');
                    return;

                } catch (pathError) {
                    addResult('api-status', `‚ö†Ô∏è PUT with path failed: ${pathError.message}`, 'error');

                    // Try PUT without path parameter
                    try {
                        const urlWithoutPath = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS);
                        addResult('api-status', `Testing PUT without path: ${urlWithoutPath}`, 'info');

                        const response2 = await Utils.apiCall(urlWithoutPath, {
                            method: "PUT",
                            headers: CONFIG.getAuthHeaders(),
                            body: JSON.stringify(testUpdateData),
                        });

                        addResult('api-status', '‚úÖ User update without path parameter working', 'success');
                        addResult('api-status', `Response: ${JSON.stringify(response2, null, 2)}`, 'info');

                    } catch (noPathError) {
                        addResult('api-status', `‚ùå Both PUT methods failed`, 'error');
                        addResult('api-status', `Path error: ${pathError.message}`, 'error');
                        addResult('api-status', `No-path error: ${noPathError.message}`, 'error');
                    }
                }

            } catch (error) {
                addResult('api-status', `‚ùå User update test failed: ${error.message}`, 'error');
            }
        }

        async function testUserUpdateDetailed() {
            try {
                const currentUser = Utils.getCurrentUser();
                if (!currentUser) {
                    addResult('api-status', '‚ùå No current user found for detailed update test', 'error');
                    return;
                }

                addResult('api-status', 'üîç Starting detailed User Update test...', 'info');
                addResult('api-status', `Current user: ${JSON.stringify(currentUser, null, 2)}`, 'info');

                const testUpdateData = {
                    userID: currentUser.sub,
                    name: 'Test User Updated Detailed',
                    email: currentUser.email,
                    preferences: {
                        genres: ['rock', 'jazz'],
                        emailNotifications: true,
                        eventReminders: true,
                        locationSuggestions: false
                    }
                };

                // Test 1: OPTIONS preflight for PUT /users/{userID}
                const urlWithPath = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS, currentUser.sub);
                addResult('api-status', `üîç Testing OPTIONS preflight for: ${urlWithPath}`, 'info');

                try {
                    const optionsResponse = await fetch(urlWithPath, {
                        method: 'OPTIONS',
                        headers: {
                            'Access-Control-Request-Method': 'PUT',
                            'Access-Control-Request-Headers': 'Content-Type,Authorization'
                        }
                    });
                    addResult('api-status', `‚úÖ OPTIONS preflight status: ${optionsResponse.status}`, 'success');
                } catch (optionsError) {
                    addResult('api-status', `‚ùå OPTIONS preflight failed: ${optionsError.message}`, 'error');
                }

                // Test 2: PUT with userID in path
                addResult('api-status', `üîç Testing PUT with userID in path: ${urlWithPath}`, 'info');
                addResult('api-status', `Request body: ${JSON.stringify(testUpdateData, null, 2)}`, 'info');

                try {
                    const response1 = await Utils.apiCall(urlWithPath, {
                        method: "PUT",
                        headers: CONFIG.getAuthHeaders(),
                        body: JSON.stringify(testUpdateData),
                    });

                    addResult('api-status', '‚úÖ PUT with userID in path SUCCESSFUL', 'success');
                    addResult('api-status', `Response: ${JSON.stringify(response1, null, 2)}`, 'info');

                } catch (pathError) {
                    addResult('api-status', `‚ùå PUT with userID in path failed: ${pathError.message}`, 'error');

                    // Test 3: OPTIONS preflight for PUT /users (without userID)
                    const urlWithoutPath = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS);
                    addResult('api-status', `üîç Testing OPTIONS preflight for: ${urlWithoutPath}`, 'info');

                    try {
                        const optionsResponse2 = await fetch(urlWithoutPath, {
                            method: 'OPTIONS',
                            headers: {
                                'Access-Control-Request-Method': 'PUT',
                                'Access-Control-Request-Headers': 'Content-Type,Authorization'
                            }
                        });
                        addResult('api-status', `‚úÖ OPTIONS preflight (no path) status: ${optionsResponse2.status}`, 'success');
                    } catch (optionsError2) {
                        addResult('api-status', `‚ùå OPTIONS preflight (no path) failed: ${optionsError2.message}`, 'error');
                    }

                    // Test 4: PUT without userID in path (userID in body)
                    addResult('api-status', `üîç Testing PUT without userID in path: ${urlWithoutPath}`, 'info');

                    try {
                        const response2 = await Utils.apiCall(urlWithoutPath, {
                            method: "PUT",
                            headers: CONFIG.getAuthHeaders(),
                            body: JSON.stringify(testUpdateData),
                        });

                        addResult('api-status', '‚úÖ PUT without userID in path SUCCESSFUL', 'success');
                        addResult('api-status', `Response: ${JSON.stringify(response2, null, 2)}`, 'info');

                    } catch (noPathError) {
                        addResult('api-status', `‚ùå PUT without userID in path failed: ${noPathError.message}`, 'error');

                        // Test 5: Direct fetch to diagnose
                        addResult('api-status', 'üîç Testing direct fetch to diagnose...', 'info');
                        try {
                            const directResponse = await fetch(urlWithPath, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem(CONFIG.STORAGE_KEYS.ID_TOKEN)}`
                                },
                                body: JSON.stringify(testUpdateData)
                            });

                            addResult('api-status', `Direct fetch status: ${directResponse.status}`, 'info');
                            const responseText = await directResponse.text();
                            addResult('api-status', `Direct fetch response: ${responseText}`, 'info');

                        } catch (directError) {
                            addResult('api-status', `‚ùå Direct fetch failed: ${directError.message}`, 'error');
                        }
                    }
                }

            } catch (error) {
                addResult('api-status', `‚ùå Detailed user update test failed: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Setup logout
            const logoutBtn = document.getElementById("logout-button");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    Utils.logout();
                });
            }

            addLog('Debug console initialized', 'success');

            // Auto-run basic tests
            setTimeout(() => {
                testAuth();
                checkConfig();
            }, 1000);
        });

        // Profile System Tests
        async function testProfileSystem() {
            clearContainer('profile-status');
            addResult('profile-status', 'üöÄ Starting comprehensive profile system test...', 'info');

            try {
                // Test 1: Authentication check
                addResult('profile-status', 'üîê Testing authentication...', 'info');
                const isAuth = Utils.isAuthenticated();
                addResult('profile-status', `Authentication status: ${isAuth}`, isAuth ? 'success' : 'error');

                if (!isAuth) {
                    addResult('profile-status', '‚ùå Cannot test profile system without authentication', 'error');
                    return;
                }

                // Test 2: Get user from token
                addResult('profile-status', 'üë§ Testing getUserFromToken...', 'info');
                const user = Utils.getUserFromToken();
                if (user) {
                    addResult('profile-status', `‚úÖ User found: ${user.email} (${user.sub})`, 'success');
                } else {
                    addResult('profile-status', '‚ùå No user found in token', 'error');
                    return;
                }

                // Test 3: Build API URL
                addResult('profile-status', 'üåê Testing buildApiUrl...', 'info');
                const apiUrl = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS, user.sub);
                addResult('profile-status', `API URL: ${apiUrl}`, 'info');

                // Test 4: Test profile API call
                addResult('profile-status', 'üì° Testing profile API call...', 'info');
                try {
                    const profileData = await Utils.apiCall(apiUrl, {
                        method: "GET",
                        headers: CONFIG.getAuthHeaders(),
                    });
                    addResult('profile-status', '‚úÖ Profile loaded from backend successfully', 'success');
                    addResult('profile-status', `Profile data: ${JSON.stringify(profileData, null, 2)}`, 'info');
                } catch (error) {
                    addResult('profile-status', `‚ö†Ô∏è Backend profile not found: ${error.message}`, 'error');
                    addResult('profile-status', 'üîß This is normal for new users - fallback profile will be created', 'info');
                }

                // Test 5: Initialize ProfilePage manually
                addResult('profile-status', 'üé® Testing ProfilePage initialization...', 'info');
                if (typeof ProfilePage !== 'undefined') {
                    // Reset the profile page state
                    ProfilePage.currentUser = null;
                    ProfilePage.userProfile = null;
                    ProfilePage.eventListenersAttached = false;

                    // Initialize
                    await ProfilePage.init();

                    if (ProfilePage.currentUser && ProfilePage.userProfile) {
                        addResult('profile-status', '‚úÖ ProfilePage initialized successfully', 'success');
                        addResult('profile-status', `Current user: ${ProfilePage.currentUser.email}`, 'success');
                        addResult('profile-status', `Profile: ${JSON.stringify(ProfilePage.userProfile, null, 2)}`, 'info');
                    } else {
                        addResult('profile-status', '‚ùå ProfilePage initialization failed', 'error');
                    }
                } else {
                    addResult('profile-status', '‚ö†Ô∏è ProfilePage not available (not on profile.html)', 'info');
                }

                addResult('profile-status', 'üéâ Profile system test completed', 'success');

            } catch (error) {
                addResult('profile-status', `‚ùå Profile system test failed: ${error.message}`, 'error');
                console.error('Profile system test error:', error);
            }
        }

        async function testTokenDecoding() {
            clearContainer('profile-status');
            addResult('profile-status', 'üîç Testing token decoding...', 'info');

            const idToken = localStorage.getItem(CONFIG.STORAGE_KEYS.ID_TOKEN);
            const accessToken = localStorage.getItem(CONFIG.STORAGE_KEYS.ACCESS_TOKEN);

            addResult('profile-status', `ID Token present: ${!!idToken}`, idToken ? 'success' : 'error');
            addResult('profile-status', `Access Token present: ${!!accessToken}`, accessToken ? 'success' : 'error');

            if (idToken) {
                addResult('profile-status', `ID Token length: ${idToken.length}`, 'info');
                addResult('profile-status', `ID Token preview: ${idToken.substring(0, 50)}...`, 'info');

                try {
                    const parts = idToken.split('.');
                    addResult('profile-status', `Token parts: ${parts.length} (expected: 3)`, parts.length === 3 ? 'success' : 'error');

                    if (parts.length === 3) {
                        const payload = parts[1];
                        const paddedPayload = payload + "=".repeat((4 - (payload.length % 4)) % 4);
                        const decodedPayload = atob(paddedPayload);
                        const userData = JSON.parse(decodedPayload);

                        addResult('profile-status', '‚úÖ Token decoded successfully', 'success');
                        addResult('profile-status', `Decoded payload: ${JSON.stringify(userData, null, 2)}`, 'info');
                    }
                } catch (error) {
                    addResult('profile-status', `‚ùå Token decoding failed: ${error.message}`, 'error');
                }
            }
        }

        async function testUserFromToken() {
            clearContainer('profile-status');
            addResult('profile-status', 'üë§ Testing Utils.getUserFromToken()...', 'info');

            try {
                const user = Utils.getUserFromToken();
                if (user) {
                    addResult('profile-status', '‚úÖ User extracted successfully', 'success');
                    addResult('profile-status', `User data: ${JSON.stringify(user, null, 2)}`, 'info');
                } else {
                    addResult('profile-status', '‚ùå No user found', 'error');
                }
            } catch (error) {
                addResult('profile-status', `‚ùå getUserFromToken failed: ${error.message}`, 'error');
            }
        }

        async function testProfileRender() {
            clearContainer('profile-status');
            addResult('profile-status', 'üé® Testing profile rendering elements...', 'info');

            const elements = [
                'display-name',
                'display-email',
                'display-bio',
                'display-member-since',
                'profile-picture',
                'favorite-genres',
                'notifications-status',
                'reminders-status'
            ];

            let foundElements = 0;
            elements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    addResult('profile-status', `‚úÖ Found element: ${elementId}`, 'success');
                    foundElements++;
                } else {
                    addResult('profile-status', `‚ùå Missing element: ${elementId}`, 'error');
                }
            });

            addResult('profile-status', `Found ${foundElements}/${elements.length} profile elements`,
                foundElements === elements.length ? 'success' : 'error');

            if (foundElements < elements.length) {
                addResult('profile-status', '‚ö†Ô∏è This test requires running on profile.html page', 'info');
            }
        }
    </script>
</body>

</html>