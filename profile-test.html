<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        button {
            background: #007cbf;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #005a87;
        }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        
        .profile-elements {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .profile-element {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>

<body>
    <h1>Profile System Test</h1>

    <div class="test-container">
        <h2>Quick Profile Test</h2>
        <button onclick="runProfileTest()">Test Profile Loading</button>
        <button onclick="testAuthentication()">Test Authentication</button>
        <button onclick="testBackendUserOps()">Test Backend User Operations</button>
        <button onclick="clearResults()">Clear Results</button>
        <div id="test-results"></div>
    </div>

    <div class="test-container">
        <h2>Profile Elements Test</h2>
        <p>These elements should exist on the profile page:</p>
        <div class="profile-elements">
            <div class="profile-element">
                <strong>display-name:</strong>
                <div id="display-name">Test Name</div>
            </div>
            <div class="profile-element">
                <strong>display-email:</strong>
                <div id="display-email">test@example.com</div>
            </div>
            <div class="profile-element">
                <strong>display-bio:</strong>
                <div id="display-bio">No bio added yet</div>
            </div>
            <div class="profile-element">
                <strong>display-member-since:</strong>
                <div id="display-member-since">January 1, 2024</div>
            </div>
            <div class="profile-element">
                <strong>profile-picture:</strong>
                <img id="profile-picture" src="" alt="Profile" style="width: 50px; height: 50px; border-radius: 50%; background: #ccc;">
            </div>
            <div class="profile-element">
                <strong>favorite-genres:</strong>
                <div id="favorite-genres">No genres selected</div>
            </div>
            <div class="profile-element">
                <strong>notifications-status:</strong>
                <div id="notifications-status">Enabled</div>
            </div>
            <div class="profile-element">
                <strong>reminders-status:</strong>
                <div id="reminders-status">Enabled</div>
            </div>
        </div>
        <button onclick="testProfileRender()">Test Profile Rendering</button>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/profile.js"></script>

    <script>
        function addResult(message, type = 'info') {
            const container = document.getElementById('test-results');
            const result = document.createElement('div');
            result.className = `result ${type}`;
            result.innerHTML = message;
            container.appendChild(result);
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        async function testAuthentication() {
            clearResults();
            addResult('üîê Testing authentication...', 'info');

            try {
                const isAuth = Utils.isAuthenticated();
                addResult(`Authentication status: ${isAuth}`, isAuth ? 'success' : 'error');

                if (isAuth) {
                    const user = Utils.getUserFromToken();
                    if (user) {
                        addResult(`‚úÖ User found: ${user.email}`, 'success');
                        addResult(`<pre>${JSON.stringify(user, null, 2)}</pre>`, 'info');
                    } else {
                        addResult('‚ùå No user data in token', 'error');
                    }
                } else {
                    addResult('‚ö†Ô∏è Please log in first at <a href="login.html">login.html</a>', 'error');
                }
            } catch (error) {
                addResult(`‚ùå Authentication test failed: ${error.message}`, 'error');
            }
        }

        async function runProfileTest() {
            clearResults();
            addResult('üöÄ Starting profile system test...', 'info');

            try {
                // Check authentication
                if (!Utils.isAuthenticated()) {
                    addResult('‚ùå Not authenticated. Please log in first.', 'error');
                    return;
                }

                const user = Utils.getUserFromToken();
                if (!user) {
                    addResult('‚ùå No user found in token', 'error');
                    return;
                }

                addResult(`‚úÖ User authenticated: ${user.email}`, 'success');

                // Test API URL building
                const apiUrl = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS, user.sub);
                addResult(`üåê API URL: ${apiUrl}`, 'info');

                // Test profile loading
                addResult('üì° Testing profile API call...', 'info');
                try {
                    const profileData = await Utils.apiCall(apiUrl, {
                        method: "GET",
                        headers: CONFIG.getAuthHeaders(),
                    });
                    addResult('‚úÖ Profile loaded from backend', 'success');
                    addResult(`<pre>${JSON.stringify(profileData, null, 2)}</pre>`, 'info');
                } catch (error) {
                    addResult(`‚ö†Ô∏è Backend profile not found: ${error.message}`, 'error');
                    addResult('Creating fallback profile...', 'info');

                    const fallbackProfile = {
                        userID: user.sub,
                        name: user.email.split("@")[0],
                        email: user.email,
                        preferences: {
                            genres: [],
                            emailNotifications: true,
                            eventReminders: true,
                            locationSuggestions: true,
                        },
                        createdAt: new Date().toISOString(),
                    };
                    addResult(`<pre>${JSON.stringify(fallbackProfile, null, 2)}</pre>`, 'info');
                }

                // Test ProfilePage if available
                if (typeof ProfilePage !== 'undefined') {
                    addResult('üé® Testing ProfilePage initialization...', 'info');

                    // Reset ProfilePage state
                    ProfilePage.currentUser = null;
                    ProfilePage.userProfile = null;
                    ProfilePage.eventListenersAttached = false;

                    await ProfilePage.init();

                    if (ProfilePage.currentUser && ProfilePage.userProfile) {
                        addResult('‚úÖ ProfilePage initialized successfully', 'success');
                        addResult(`Profile data: <pre>${JSON.stringify(ProfilePage.userProfile, null, 2)}</pre>`, 'info');
                    } else {
                        addResult('‚ùå ProfilePage initialization failed', 'error');
                    }
                } else {
                    addResult('‚ö†Ô∏è ProfilePage not available (expected on profile.html)', 'info');
                }

                addResult('üéâ Profile test completed', 'success');

            } catch (error) {
                addResult(`‚ùå Profile test failed: ${error.message}`, 'error');
                console.error('Profile test error:', error);
            }
        }

        function testProfileRender() {
            clearResults();
            addResult('üé® Testing profile element rendering...', 'info');

            // Simulate profile data
            const mockProfile = {
                name: "Test User",
                email: "test@example.com",
                bio: "This is a test bio",
                createdAt: new Date().toISOString(),
                profilePictureUrl: "https://via.placeholder.com/50",
                preferences: {
                    genres: ["rock", "jazz"],
                    emailNotifications: true,
                    eventReminders: false
                }
            };

            // Test rendering
            if (typeof ProfilePage !== 'undefined') {
                ProfilePage.userProfile = mockProfile;
                ProfilePage.renderProfile();
                addResult('‚úÖ Profile rendered with mock data', 'success');
            } else {
                // Manual rendering for testing
                document.getElementById('display-name').textContent = mockProfile.name;
                document.getElementById('display-email').textContent = mockProfile.email;
                document.getElementById('display-bio').textContent = mockProfile.bio;
                document.getElementById('display-member-since').textContent = new Date(mockProfile.createdAt).toLocaleDateString();
                document.getElementById('profile-picture').src = mockProfile.profilePictureUrl;
                document.getElementById('favorite-genres').innerHTML = mockProfile.preferences.genres.map(g => `<span style="background:#e9ecef;padding:2px 6px;border-radius:3px;margin:2px;">${g}</span>`).join('');
                document.getElementById('notifications-status').textContent = mockProfile.preferences.emailNotifications ? 'Enabled' : 'Disabled';
                document.getElementById('reminders-status').textContent = mockProfile.preferences.eventReminders ? 'Enabled' : 'Disabled';

                addResult('‚úÖ Elements updated with mock data', 'success');
            }
        }

        // Auto-run tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            addResult('üîß Profile test page loaded', 'info');
            addResult('Click "Test Profile Loading" to run comprehensive tests', 'info');
        });

        async function testBackendUserOps() {
            clearResults();
            addResult('üîß Testing backend user operations...', 'info');

            try {
                if (!Utils.isAuthenticated()) {
                    addResult('‚ùå Not authenticated. Please log in first.', 'error');
                    return;
                }

                const user = Utils.getUserFromToken();
                if (!user) {
                    addResult('‚ùå No user found in token', 'error');
                    return;
                }

                addResult(`‚úÖ Testing with user: ${user.email} (${user.sub})`, 'success');

                // Test 1: Try to GET user profile
                addResult('üì° Testing GET user profile...', 'info');
                const getUserUrl = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS, user.sub);
                try {
                    const existingProfile = await Utils.apiCall(getUserUrl, {
                        method: "GET",
                        headers: CONFIG.getAuthHeaders(),
                    });
                    addResult('‚úÖ User profile exists in backend', 'success');
                    addResult(`<pre>${JSON.stringify(existingProfile, null, 2)}</pre>`, 'info');
                } catch (error) {
                    addResult(`‚ö†Ô∏è User profile not found: ${error.message}`, 'error');
                    
                    // Test 2: Try to CREATE user profile
                    addResult('üì° Testing POST create user profile...', 'info');
                    const createUserUrl = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS);
                    const newUserData = {
                        userID: user.sub,
                        name: user.email.split("@")[0],
                        email: user.email,
                        preferences: {
                            genres: ["test"],
                            emailNotifications: true,
                            eventReminders: true,
                            locationSuggestions: true,
                        },
                        bio: "Test bio",
                        location: "Test location",
                        website: "https://test.com",
                        profilePictureUrl: null,
                        createdAt: new Date().toISOString(),
                    };

                    try {
                        const createdProfile = await Utils.apiCall(createUserUrl, {
                            method: "POST",
                            headers: CONFIG.getAuthHeaders(),
                            body: JSON.stringify(newUserData),
                        });
                        addResult('‚úÖ User profile created successfully', 'success');
                        addResult(`<pre>${JSON.stringify(createdProfile, null, 2)}</pre>`, 'info');
                    } catch (createError) {
                        addResult(`‚ùå Failed to create user: ${createError.message}`, 'error');
                    }
                }

                // Test 3: Try to UPDATE user profile
                addResult('üì° Testing PUT update user profile...', 'info');
                const updateUserUrl = CONFIG.buildApiUrl(CONFIG.API.ENDPOINTS.USERS, user.sub);
                const updateData = {
                    userID: user.sub,
                    name: user.email.split("@")[0] + " (Updated)",
                    email: user.email,
                    preferences: {
                        genres: ["rock", "jazz"],
                        emailNotifications: false,
                        eventReminders: true,
                        locationSuggestions: false,
                    },
                    bio: "Updated test bio",
                    location: "Updated location",
                    website: "https://updated.com",
                    profilePictureUrl: "https://test-image-url.com/test.jpg",
                    createdAt: new Date().toISOString(),
                };

                try {
                    const updatedProfile = await Utils.apiCall(updateUserUrl, {
                        method: "PUT",
                        headers: CONFIG.getAuthHeaders(),
                        body: JSON.stringify(updateData),
                    });
                    addResult('‚úÖ User profile updated successfully', 'success');
                    addResult(`<pre>${JSON.stringify(updatedProfile, null, 2)}</pre>`, 'info');
                } catch (updateError) {
                    addResult(`‚ùå Failed to update user: ${updateError.message}`, 'error');
                    addResult('üîç This suggests the Lambda function may need to be redeployed with the latest FIXED_USER_LAMBDA.js code', 'error');
                }

                addResult('üéâ Backend user operations test completed', 'success');

            } catch (error) {
                addResult(`‚ùå Backend test failed: ${error.message}`, 'error');
                console.error('Backend test error:', error);
            }
        }
    </script>
</body>

</html>